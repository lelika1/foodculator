<html>

<head>
    <title>Foodculator 1.0</title>
    <link rel="icon" href="/static/icon.svg">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body onload="getProductsFunction()">
    <h1>All products:</h1>
    <select id="ingredients"></select>

    <h1>Add a new product</h1>
    <label for="product">Product:</label>
    <input type="text" id="product"><br><br>

    <label for="kcal">kcal:</label>
    <input type="number" min="0" max="10000" value="0" id="kcal" onkeydown="callOnEnter(addProduct)">
    <label for="kcal">for 100g</label><br><br>

    <input type="submit" value="Submit" onclick="addProduct()">
    <label id="response"></label>
</body>

<script>
    function callOnEnter(fn) {
        if (event.key === 'Enter') {
            fn();
        }
    }

    function addProduct() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            document.getElementById("response").innerHTML = this.responseText;
            if (this.readyState == 4 && this.status == 200) {
                $("#ingredients").append($("<option>")
                    .text(`${$("#product").val()} ${$("#kcal").val()} kcal`));
                $("#kcal").val(0);
                $("#product").val('').focus();
            }
        };

        xhttp.open("POST", "/add_ingredient", true);
        xhttp.send(JSON.stringify({
            "product": $("#product").val(),
            "kcal": parseInt($("#kcal").val())
        }));
    }

    function getProductsFunction() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                JSON.parse(this.responseText).forEach(pr =>
                    $("#ingredients").append($("<option>")
                        .text(`${pr.name} ${pr.kcal} kcal`))
                );
            }
        };

        xhttp.open("GET", "/get_ingredients", true);
        xhttp.send();
    }
</script>

</html>