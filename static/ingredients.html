<html>

<head>
    <title>Foodculator 1.0</title>
    <link rel="icon" href="/static/icon.svg">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
        th,
        td {
            padding: 5px;
            text-align: left;
        }

        th {
            background-color: lavender;
        }

        input {
            width: 100%;
        }
    </style>
</head>

<body onload="getProductsFunction()">
    <table id="ingredients" style="width:50%">
        <tr>
            <td colspan="2">
                <span style="font-size: x-large;">Add a new product</span>
            </td>
        </tr>
        <tr>
            <td>
                <input type="text" id="product" placeholder="product's name">
            </td>
            <td>
                <input type="number" min="0" max="10000" id="kcal" onkeydown="callOnEnter(addProduct)"
                    placeholder="kcal for 100g">
            </td>
            <td>
                <input type="submit" value="Add" onclick="addProduct()">
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <label id="prNameResponse" style="font-weight: bold; color: green; font-style: italic"></label>
                <label id="response"></label>
            </td>
        </tr>

        <tr>
            <td colspan="2">
                <span style="font-size: x-large;">All products:</span>
            </td>
        </tr>

        <tr>
            <th>Product</th>
            <th>Calorie</th>
        </tr>

        <tr>
            <td colspan="2"></td>
        </tr>
    </table>
</body>

<script>
    function callOnEnter(fn) {
        if (event.key === 'Enter') {
            fn();
        }
    }

    function addProduct() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    let dltBtn = $("<input type=submit value=Delete>");
                    $('#ingredients').append($("<tr>")
                        .attr("dbId", parseInt(this.response))
                        .append($("<td>").text($("#product").val()))
                        .append($("<td>").text($("#kcal").val()))
                        .append($("<td>").append(dltBtn))
                    )

                    $("#prNameResponse").text($("#product").val());
                    $("#response").text(" successfully added.").attr("style", "color:green;");

                    $("#kcal").val("");
                    $("#product").val('').focus();
                } else {
                    $("#prNameResponse").text("");
                    $("#response").text(this.responseText).attr("style", "color:red;");
                }
            }
        };

        xhttp.open("POST", "/add_ingredient", true);
        xhttp.send(JSON.stringify({
            "product": $("#product").val(),
            "kcal": parseInt($("#kcal").val())
        }));
    }

    function getProductsFunction() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                JSON.parse(this.responseText).forEach(pr => {
                    let dltBtn = $("<input type=submit value=Delete>");
                    $('#ingredients').append($("<tr>")
                        .attr("dbId", pr.id)
                        .append($("<td>").text(pr.name))
                        .append($("<td>").text(pr.kcal))
                        .append($("<td>").append(dltBtn))
                    )
                }
                );
            }
        }

        xhttp.open("GET", "/get_ingredients", true);
        xhttp.send();
    }
</script>

</html>