<html>

<head>
    <title>Foodculator 1.0</title>
    <link rel="icon" href="/static/icon.svg">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <style>
        th,
        td {
            padding: 5px;
            text-align: left;
        }

        th {
            background-color: lavender;
        }

        #recipe tr:last-child {
            background-color: aliceblue;
        }

        #recipe input {
            width: 100%;
        }
    </style>

</head>

<body onload="loadData()">
    <h1>Create a new recipe</h1>

    <table id="recipe" style="width:40%">
        <tr>
            <th>Ingredient</th>
            <th>Amount</th>
        </tr>
        <tr>
            <td>
                <input list="ingredients" id="getIngredient" placeholder="Choose an ingredient" autofocus>
                <datalist id="ingredients"></datalist>
            </td>
            <td>
                <input type="number" min="0" max="10000" value="0" id="gram" onkeydown="callOnEnter(addNextIngredient)">
            </td>
        </tr>
    </table><br>

    <span style="font-size: x-large;">Choose a &#127858;:</span>
    <div id="tableware">
    </div><br>

    <div>
        <span style="font-size: x-large;">Total weight:</span>
        <input type="number" min="1" max="10000" value="1" id="totalWeight" onkeydown="callOnEnter(calculate)">
        <label for="totalWeight">grams</label>
    </div>
    <br>
    <button id="calculate" onclick="calculate()"> Calculate food energy </button><br>

    <label id="textResult"></label><br><br>
    <label id="calcResult"></label><br><br>

    <script>
        function loadData() {
            loadProducts();
            loadTableware();
        }

        function loadProducts() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    JSON.parse(this.responseText).products
                        .forEach(pr =>
                            $("#ingredients").append($("<option>")
                                .attr('kcal', pr.kcal)
                                .text(`${pr.name} ${pr.kcal} kcal`))
                        );
                }
            };

            xhttp.open("GET", "/get_ingredients", true);
            xhttp.send();
        }

        function addItemToTableware(weight, name, text, checked = false) {
            let id = `pod${$("input[name='tableware']").length}`
            let radio = $('<input type=radio>')
                .attr('name', name)
                .attr('checked', checked)
                .attr('id', id)
                .val(weight);

            $('#tableware')
                .append(radio)
                .append($("<label>").attr('for', id).text(text))
                .append("<br>");
        }

        function loadTableware() {
            addItemToTableware(0, 'tableware', "No pot", true);

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    JSON.parse(this.responseText).tableware
                        .forEach(tw => {
                            let text = `${tw.name} ${tw.weight} g`;
                            addItemToTableware(tw.weight, 'tableware', text);
                        });
                }
            };

            xhttp.open("GET", "/get_tableware", true);
            xhttp.send();
        }

        function callOnEnter(fn) {
            if (event.key === 'Enter') {
                fn();
            }
        }

        var allIngredients = [];

        function addNextIngredient() {
            let grams = $("#gram").val();
            if (grams == 0) {
                return;
            }

            var product = $("#getIngredient").val();
            var found = $('#ingredients option').filter((idx, el) => el.value === product);
            if (found.length == 0) {
                return;
            }

            let edit = $('<input type="number" min=0 max=10000>')
                .val(grams);

            $('#recipe tr:last').before($("<tr>")
                .append($("<td>").text(product))
                .append($("<td>").append(edit))
            );

            allIngredients.push({
                kcal: $(found[0]).attr("kcal"),
                weight: edit
            });

            $("#gram").val(0);
            $("#getIngredient").val('').focus();
        }

        function calculate() {
            if (allIngredients.length == 0) {
                return;
            }

            var totalEnergy = 0.0;
            var result = [];
            for (let ing of allIngredients) {
                let weight = ing.weight.val();
                totalEnergy += ing.kcal * weight / 100.0;
                result.push(`${ing.kcal}*${weight / 100.0}`);
            }

            let totalWeight = parseInt($("#totalWeight").val());
            let twWeight = parseInt($("input[name='tableware']:checked").val());
            if (totalWeight <= twWeight) {
                return;
            }

            totalEnergy = totalEnergy * 100 / (totalWeight - twWeight);
            $("#calcResult").text(`Final energy is ${totalEnergy} kcal per 100 g.`);

            var text = `(${result.join(" + ")}) * 100 / (${totalWeight}-${twWeight}) = ${totalEnergy}`;
            $("#textResult").text(text);
        }
    </script>
</body>

</html>