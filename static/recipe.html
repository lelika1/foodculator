<html>

<head>
    <title>Foodculator 1.0</title>
    <link rel="icon" href="/static/icon.svg">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <style>
        th,
        td {
            padding: 5px;
            text-align: left;
        }

        th {
            background-color: lavender;
        }

        #recipe tr:last-child {
            background-color: aliceblue;
        }

        #recipe input {
            width: 100%;
        }

        #left {
            position: absolute;
            left: 0;
            top: 0;
            width: 60%;
        }

        #right {
            position: absolute;
            right: 0;
            top: 10%;
            width: 40%;
        }
    </style>

</head>

<body onload="loadData()">
    <div id="left">
        <h1>Create a new recipe</h1>
        <table id="recipe" style="width:80%">
            <tr>
                <th>Ingredient</th>
                <th>Amount</th>
            </tr>
            <tr>
                <td>
                    <input list="ingredients" id="getIngredient" placeholder="Choose an ingredient" autofocus
                        onkeydown="callOnEnter(setFocusOnNextInput, this)">

                    <datalist id="ingredients"></datalist>
                </td>
                <td>
                    <input type="number" min="0" max="10000" value="0" id="gram"
                        onkeydown="callOnEnter(addNextIngredient)">
                </td>
            </tr>
        </table><br>

        <span style="font-size: x-large;">Choose a &#127858;:</span>
        <div id="tableware">
        </div><br>

        <div>
            <span style="font-size: x-large;">Total weight:</span>
            <input type="number" min="1" max="10000" value="1" id="totalWeight" oninput="onRecipeChange()">
            <label for="totalWeight">grams</label>
        </div>
        <br>

        <div>
            <label id="textResult"></label><br><br>
            <label id="calcResult"></label>
            <label id="finalKcalMsg"></label><br><br>
            <label id="totalWeightMsg"></label><br><br>
        </div>

        <button onclick="reset()">Reset all</button>

    </div>

    <div id="right">
        <a href="javascript:hideDiv('newProductDiv');" style="font-size: x-large;">Add a new product</a>
        <div id="newProductDiv" style="display: none;">
            <span style="font-size: large;">Product:</span>
            <input type="text" id="product" onkeydown="callOnEnter(setFocusOnNextInput, this)"><br><br>

            <span style="font-size: large;">kcal:</span>
            <input type="number" min="0" max="10000" value="0" id="kcal" onkeydown="callOnEnter(addNewProduct)">
            <span style="font-size: large;">for 100g</span><br><br>

            <input type="submit" value="Add a new product" onclick="addNewProduct()">

            <label id="prNameResponse" style="font-weight: bold; color: green; font-style: italic"></label>
            <label id="newProductResponse"></label>
        </div><br><br>

        <a href="javascript:hideDiv('newTwDiv');" style="font-size: x-large;">Add a new pot</a>
        <div id="newTwDiv" style="display: none;">
            <span style="font-size: large;">Name:</span>
            <input type="text" id="newTwName" onkeydown="callOnEnter(setFocusOnNextInput, this)"><br><br>

            <span style="font-size: large;">Weight:</span>
            <input type="number" min="0" max="10000" value="0" id="newTwWeight" onkeydown="callOnEnter(addNewTw)">
            <span style="font-size: large;">grams</span><br><br>

            <input type="submit" value="Add a new pot" onclick="addNewTw()">

            <label id="twNameResponse" style="font-weight: bold; color: green; font-style: italic"></label>
            <label id="newTwResponse"></label>
        </div>
    </div>

    <script>
        var allProducts = [];
        var allIngredients = [];

        function loadData() {
            loadProducts(onProductsLoad);
            loadTableware();
        }

        function loadProducts(callback) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    callback(JSON.parse(this.responseText));
                }
            };

            xhttp.open("GET", "/get_ingredients", true);
            xhttp.send();
        }

        function onProductsLoad(products) {
            products.forEach(pr => {
                let name = `${pr.name} ${pr.kcal} kcal`;
                $("#ingredients").append($("<option>").text(name)
                    .attr('kcal', pr.kcal).attr('id', pr.id)
                );
                allProducts[pr.id] = { kcal: pr.kcal, name: name, id: pr.id };
            });

            let recipe = JSON.parse(sessionStorage.getItem("allIngredients")) || [];
            for (let ingr of recipe) {
                if (!(ingr.id in allProducts)) {
                    onRecipeChange();
                    return;
                }
            }

            recipe.forEach(ingr => addNextIngredientForm(ingr.id, ingr.weight));
            onRecipeChange();
        }

        function addItemToTableware(weight, name, text, checked = false) {
            let id = `pod${$("input[name='tableware']").length}`
            let radio = $('<input type=radio>')
                .attr('name', name)
                .attr('checked', checked)
                .attr('id', id)
                .attr('onclick', 'onRecipeChange()')
                .val(weight);

            $('#tableware')
                .append(radio)
                .append($("<label>").attr('for', id).text(text))
                .append("<br>");
        }

        function loadTableware() {
            addItemToTableware(0, 'tableware', "No pot", true);

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    JSON.parse(this.responseText).forEach(tw => {
                        let text = `${tw.name} ${tw.weight} g`;
                        addItemToTableware(tw.weight, 'tableware', text);
                    });
                }
            };

            xhttp.open("GET", "/get_tableware", true);
            xhttp.send();
        }

        function callOnEnter(fn, ...params) {
            if (event.key === 'Enter') {
                fn(params);
            }
        }

        function setFocusOnNextInput(current) {
            if (current.length != 1) {
                return;
            }
            $(":input:eq(" + ($(":input").index(current[0]) + 1) + ")").focus();
        }

        function addNextIngredient() {
            let grams = $("#gram").val();
            if (grams == 0) {
                return;
            }

            var product = $("#getIngredient").val();
            var found = $('#ingredients option').filter((idx, el) => el.value === product);
            if (found.length == 0) {
                return;
            }

            addNextIngredientForm($(found[0]).attr("id"), grams);
            onRecipeChange();
        }

        function addNextIngredientForm(id, weight) {
            let edit = $('<input type="number" min=0 max=10000>')
                .val(weight).attr("oninput", "onRecipeChange()");

            $('#recipe tr:last').before($("<tr>")
                .append($("<td>").text(allProducts[id].name))
                .append($("<td>").append(edit))
            );

            allIngredients.push({
                id: id,
                weight: edit,

                toJSON() {
                    return { "id": this.id, "weight": $(this.weight).val() };
                }
            });

            $("#gram").val(0);
            $("#getIngredient").val('').focus();
        }

        function onRecipeChange() {
            sessionStorage.setItem("allIngredients", JSON.stringify(allIngredients));

            if (allIngredients.length == 0) {
                $("#textResult").text("There is no ingredients yet.")
                    .attr("style", "color:red;");
                $("#calcResult").text("");
                $("#finalKcalMsg").text("");
                $("#totalWeightMsg").text("");
                return;
            }

            var totalEnergy = 0.0;
            var result = [];
            allIngredients.forEach(ingr => {
                let weight = ingr.weight.val();
                let kcal = allProducts[ingr.id].kcal;
                totalEnergy += kcal * weight / 100.0;
                result.push(`${kcal}*${weight / 100.0}`);
            });

            let totalWeight = parseInt($("#totalWeight").val());
            let twWeight = parseInt($("input[name='tableware']:checked").val());
            if ($("#totalWeight").val() == "" || totalWeight <= twWeight) {
                $("#textResult").text("The total weight should be greater than the pot's weight.")
                    .attr("style", "color:red;");
                $("#calcResult").text("");
                $("#finalKcalMsg").text("");
                $("#totalWeightMsg").text("");
                return;
            }

            totalEnergy = totalEnergy * 100 / (totalWeight - twWeight);
            $("#calcResult").text("Final energy is ");
            $("#finalKcalMsg").text(`${totalEnergy.toFixed(2)} kcal per 100 g.`).attr("style", "font-weight:bold");
            $("#totalWeightMsg").text(`Total weight is ${totalWeight - twWeight} g`);

            var text = `(${result.join(" + ")}) * 100 / (${totalWeight}-${twWeight}) = ${totalEnergy}`;
            $("#textResult").text(text).attr("style", "color:black;");
        }

        function addNewTw() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        let weight = $("#newTwWeight").val();
                        let name = $("#newTwName").val();
                        addItemToTableware(weight, 'tableware',
                            `${$("#newTwName").val()} ${$("#newTwWeight").val()} g`);

                        $("#twNameResponse").text($("#newTwName").val());
                        $("#newTwResponse").text(" successfully added.").attr("style", "color:green;");

                        $("#newTwWeight").val(0);
                        $("#newTwName").val('').focus();
                    } else {
                        $("#twNameResponse").text("");
                        $("#newTwResponse").text(this.responseText).attr("style", "color:red;");
                    }
                }
            };

            xhttp.open("POST", "/add_tableware", true);
            xhttp.send(JSON.stringify({
                "name": $("#newTwName").val(),
                "weight": parseInt($("#newTwWeight").val())
            }));
        }

        function addNewProduct() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        let kcal = $("#kcal").val();
                        let id = parseInt(this.responseText);
                        let name = `${$("#product").val()} ${kcal} kcal`;
                        allProducts[id] = { kcal: kcal, name: name, id: id };

                        $("#ingredients").append($("<option>")
                            .attr('kcal', kcal)
                            .attr('id', id)
                            .text(name));
                        $("#prNameResponse").text($("#product").val());
                        $("#newProductResponse").text(" successfully added.").attr("style", "color:green;");

                        $("#kcal").val(0);
                        $("#product").val('').focus();
                    } else {
                        $("#prNameResponse").text("");
                        $("#newProductResponse").text(this.responseText).attr("style", "color:red;");
                    }
                }
            };

            xhttp.open("POST", "/add_ingredient", true);
            xhttp.send(JSON.stringify({
                "product": $("#product").val(),
                "kcal": parseInt($("#kcal").val())
            }));
        }

        function hideDiv(divName) {
            var div = $(`#${divName}`);
            if (div.css("display") === "none") {
                div.attr("style", "display:block");
                div.find('input').first().focus();
            } else {
                div.attr("style", "display:none");
                $("#getIngredient").focus();
            }
        }

        function reset() {
            sessionStorage.removeItem("allIngredients");
            location.reload();
        }

    </script>
</body>

</html>